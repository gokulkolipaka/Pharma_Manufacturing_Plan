<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pharma Resource Planning System</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Minor calendar enhancements (add to your style.css if you want better grid look) */
    .calendar-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }
    .calendar-header-row {
      display: grid;
      grid-template-columns: 150px repeat(var(--equipment-count, 3), 1fr);
      background: var(--color-bg-3, #e6f7fa);
      font-weight: 600;
      min-width:750px;
    }
    .calendar-header-cell,
    .calendar-equipment-cell {
      padding: 10px 6px;
      border-bottom: 2px solid var(--color-border, #e4e4e4);
      border-right: 1px solid var(--color-border, #e4e4e4);
      background: var(--color-bg-3, #e6f7fa);
      font-size: 15px;
      position: relative;
      min-width: 100px;
      box-sizing: border-box;
    }
    .calendar-header-cell:first-child { border-left: 1px solid var(--color-border, #e4e4e4); }
    .calendar-equipment-cell.editing {
      background: #fffbe2;
      outline: 2px solid var(--color-primary, #1FAEB7);
    }
    .calendar-day-row {
      display: grid;
      grid-template-columns: 150px repeat(var(--equipment-count, 3), 1fr);
      background:#fff;
      min-width:750px;
    }
    .calendar-day-cell, .calendar-equipment-name-cell {
      min-height: 60px;
      padding: 6px;
      border-bottom: 1px solid var(--color-border, #e4e4e4);
      border-right: 1px solid var(--color-border, #e4e4e4);
      background: #fff;
      box-sizing: border-box;
      font-size: 14px;
      vertical-align: top;
    }
    .calendar-equipment-name-cell {
      font-weight: 600;
      background: #f3fbff;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
      position: relative;
    }
    .calendar-equipment-name-cell.editing {
      outline: 2px solid var(--color-primary, #1FAEB7);
      background: #fffbe2;
    }
    .calendar-day-row:last-child .calendar-day-cell, .calendar-day-row:last-child .calendar-equipment-name-cell {
      border-bottom: none;
    }
    .calendar-day-cell.conflict {
      background: #ffe8e8;
      border: 2px solid #d94b4b;
    }
    .calendar-toolbar .btn { margin-left: 4px; }
    .add-equipment-btn { margin-left: 20px; }

    /* Responsive tweak for calendar */
    @media (max-width: 960px) {
      .calendar-header-row,
      .calendar-day-row { min-width: 600px; }
    }
    @media (max-width: 700px) {
      .calendar-header-row,
      .calendar-day-row { min-width: 400px; font-size:13px;}
      .calendar-equipment-name-cell { font-size:13px;}
    }
  </style>
</head>
<body>
  <!-- Login and Main App here (unchanged) -->
  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>Pharma Resource Planning</h1>
        <p>Secure Login</p>
      </div>
      <div class="login-tabs">
        <button class="tab-btn active" data-tab="login">Login</button>
        <button class="tab-btn" data-tab="signup">Sign Up</button>
      </div>
      <form id="login-form" class="auth-form active">
        <div class="form-group">
          <label>Username</label>
          <input id="login-username" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="login-password" type="password" class="form-control" required>
        </div>
        <button class="btn btn--primary" type="submit">Login</button>
      </form>
      <form id="signup-form" class="auth-form">
        <div class="form-group">
          <label>Username</label>
          <input id="signup-username" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input id="signup-email" class="form-control" type="email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="signup-password" type="password" class="form-control" required>
        </div>
        <div class="form-group">
          <label>User Role</label>
          <select id="signup-role" class="form-control" required>
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button class="btn btn--primary" type="submit">Create Account</button>
      </form>
    </div>
  </div>
  
  <div id="main-app" class="main-app hidden">
    <header class="app-header">
      <div class="header-content">
        <div class="company-info">
          <div class="logo-container" id="logo-placeholder" title="Upload company logo">
            <img id="company-logo" src="" style="display:none;" alt="Logo"/>
            <span class="logo-placeholder" style="display:block;">Add Logo</span>
            <input class="sr-only" id="logo-upload" type="file" accept="image/*" style="display:none;">
          </div>
          <div class="company-details">
            <h1 id="company-name">PharmaCorp Manufacturing</h1>
            <input id="company-name-input" class="company-name-input" style="display:none;">
          </div>
        </div>
        <div class="user-info">
          <span id="user-welcome"></span>
          <button class="btn btn--secondary" id="logout-btn" title="Logout">Logout</button>
        </div>
      </div>
    </header>
    <nav class="app-nav">
      <div class="nav-content">
        <button class="nav-btn active" data-view="dashboard">Dashboard</button>
        <button class="nav-btn" data-view="production">Production Plans</button>
        <button class="nav-btn" data-view="calendar">Equipment Calendar</button>
        <button class="nav-btn" data-view="stock">Stock Management</button>
        <button class="nav-btn" data-view="reports">Reports</button>
        <button class="nav-btn admin-only hidden" data-view="users">User Management</button>
      </div>
    </nav>
    <main class="app-main">
      <!-- DASHBOARD -->
      <section class="view active" id="dashboard-view">
        <div class="view-header">
          <h2>Production Overview</h2>
          <div id="dashboard-customize-btn"></div>
        </div>
        <div class="dashboard-grid">
          <div class="dashboard-card" id="production-trend-card">
            <h3>Units This Month</h3>
            <div class="stat-value" id="total-production">0</div>
            <canvas id="production-chart" style="width:100%;height:120px;min-height:100px;"></canvas>
          </div>
          <div class="dashboard-card" id="utilization-card">
            <h3>Equipment Status</h3>
            <div class="equipment-status">
              <div class="status-item"><span>Available:</span> <span class="stat-value" id="available-equipment">0</span></div>
              <div class="status-item"><span>In Use:</span> <span class="stat-value" id="busy-equipment">0</span></div>
              <div class="status-item"><span>Maintenance:</span> <span class="stat-value" id="maintenance-equipment">0</span></div>
            </div>
          </div>
          <div class="dashboard-card" id="stock-alerts-card">
            <h3>Stock Alerts</h3>
            <div class="alerts-container" id="stock-alerts"></div>
          </div>
        </div>
        <div class="dashboard-card full-width">
          <h3>Production Analytics</h3>
        </div>
      </section>
      <!-- PRODUCTION PLANS -->
      <section class="view" id="production-view">
        <div class="view-header">
          <h2>Production Planning</h2>
          <button class="btn btn--primary" id="add-production-btn">Add Production Plan</button>
        </div>
        <div id="production-plans-list"></div>
      </section>
      <!-- EQUIPMENT CALENDAR -->
      <section class="view" id="calendar-view">
        <div class="view-header">
          <h2>Equipment Calendar</h2>
        </div>
        <div class="calendar-toolbar">
          <div>
            <button class="btn btn--secondary" id="prev-month">&#8592; Prev</button>
            <span id="calendar-month-label">March 2025</span>
            <button class="btn btn--secondary" id="next-month">Next &#8594;</button>
          </div>
          <button class="btn btn--primary add-equipment-btn" id="calendar-add-equipment-btn" title="Add Equipment">+ Add Equipment</button>
        </div>
        <div id="equipment-calendar"></div>
      </section>
      <!-- STOCK MANAGEMENT -->
      <section class="view" id="stock-view">
        <div class="view-header">
          <h2>Stock Management</h2>
          <button class="btn btn--primary" id="add-material-btn">Add Material</button>
          <button class="btn btn--secondary" id="upload-stock-btn">Upload from Excel</button>
        </div>
        <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" style="display:none;">
        <div class="stock-grid" id="materials-list"></div>
      </section>
      <!-- REPORTS -->
      <section class="view" id="reports-view">
        <div class="view-header">
          <h2>Reports</h2>
          <div class="report-actions">
            <button class="btn btn--outline" id="export-csv-btn">Export CSV</button>
            <button class="btn btn--outline" id="export-pdf-btn">Export PDF</button>
            <button class="btn btn--outline" id="print-report-btn">Print</button>
          </div>
        </div>
        <div class="reports-grid" id="reports-list"></div>
      </section>
      <!-- USER MANAGEMENT -->
      <section class="view" id="users-view">
        <div class="view-header">
          <h2>User Management</h2>
          <button class="btn btn--primary admin-only" id="add-user-btn">Add User</button>
        </div>
        <div class="users-grid" id="users-list"></div>
      </section>
      <!-- EQUIPMENT MANAGEMENT PANEL -->
      <section>
        <div id="equipment-panel"></div>
      </section>
    </main>
  </div>
  <div class="toast-container" id="toast-container"></div>
  
  <!-- MODALS -->
  <!-- ... all MODAL HTML (password, production, material, user, etc. as before) ... -->
  <!-- Equipment Modal (Add/Edit) -->
  <div class="modal hidden" id="equipment-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="equipment-modal-title">Add Equipment</h3>
        <button class="modal-close" type="button" aria-label="Close">&times;</button>
      </div>
      <form id="equipment-form">
        <input type="hidden" id="equipment-id">
        <div class="form-group">
          <label for="equipment-name" class="form-label">Name</label>
          <input class="form-control" id="equipment-name" required>
        </div>
        <div class="form-group">
          <label for="equipment-type" class="form-label">Type</label>
          <input class="form-control" id="equipment-type" required>
        </div>
        <div class="form-group">
          <label for="equipment-location" class="form-label">Location</label>
          <input class="form-control" id="equipment-location">
        </div>
        <div class="form-group">
          <label for="equipment-status" class="form-label">Status</label>
          <select class="form-control" id="equipment-status">
            <option value="Available">Available</option>
            <option value="In Use">In Use</option>
            <option value="Maintenance">Maintenance</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn btn--primary" type="submit">Save</button>
          <button class="btn btn--secondary modal-close" type="button">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Dashboard Customize Modal -->
  <div class="modal hidden" id="dashboard-edit-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>Customize Dashboard</h3>
        <button class="modal-close" type="button" aria-label="Close">&times;</button>
      </div>
      <form id="dashboard-settings-form">
        <label><input type="checkbox" id="dash-prod-trend" /> Show Production Trend</label><br>
        <label><input type="checkbox" id="dash-utilization" /> Show Equipment Utilization</label><br>
        <label><input type="checkbox" id="dash-stock-alerts" /> Show Stock Alerts</label><br>
        <div class="modal-actions">
          <button class="btn btn--primary" type="submit">Save</button>
          <button class="btn btn--secondary modal-close" type="button">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <!-- ...rest of your modals (user, password, materials, etc.) ... -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="app.js"></script>
  <!-- CALENDAR/EQUIPMENT JS below -->
  <script>
    // ------------ Equipment Calendar UI with editable equipment names --------------------
    (function () {
      // For date navigation
      function getMonthName(monthIdx) {
        return [
          'January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'
        ][monthIdx];
      }

      // Main render function for the calendar
      window.renderEquipmentCalendar = function (month=null, year=null) {
        // Get equipment & calendar data
        let equipmentList = JSON.parse(localStorage.getItem('pharma_equipment') || '[]');
        let calendarEntries = JSON.parse(localStorage.getItem('pharma_calendar') || '[]');
        equipmentList = Array.isArray(equipmentList) ? equipmentList : [];

        // Current month/year state
        let dt = new Date();
        let curMonth = (typeof month === 'number' && !isNaN(month)) ? month : (window.equipCalendarMonth !== undefined ? window.equipCalendarMonth : dt.getMonth());
        let curYear = (typeof year === 'number' && !isNaN(year)) ? year : (window.equipCalendarYear !== undefined ? window.equipCalendarYear : dt.getFullYear());
        window.equipCalendarMonth = curMonth;
        window.equipCalendarYear = curYear;

        // Days in month
        let daysInMonth = new Date(curYear, curMonth+1, 0).getDate();

        // Set equipment count for grid
        document.getElementById('equipment-calendar').style.setProperty('--equipment-count', equipmentList.length || 1);

        // Calendar month label
        document.getElementById('calendar-month-label').textContent = `${getMonthName(curMonth)} ${curYear}`;

        // Header row (equipment names)
        let headerRow = `<div class="calendar-header-row">
          <div class="calendar-header-cell"></div>
          ${equipmentList.map(eq => `<div class="calendar-header-cell"><span class="calendar-equipment-name-cell" data-equipment-id="${eq.id}" tabindex="0">${eq.name}</span></div>`).join('')}
        </div>`;

        // Day rows
        let rows = '';
        for(let d=1; d<=daysInMonth; ++d) {
          rows += `<div class="calendar-day-row">
            <div class="calendar-day-cell calendar-header-cell">${d}</div>`;
          for(let c=0; c<equipmentList.length; ++c) {
            let equipId = equipmentList[c].id;
            let dayEntry = calendarEntries.find(e=>e.day===d && e.month===curMonth && e.year===curYear && e.equipmentId===equipId);
            let classes = "calendar-day-cell";
            let text = "";
            if(dayEntry) {
              text = dayEntry.info || "";
              if(dayEntry.conflict) classes += " conflict";
            }
            rows += `<div class="${classes}" 
                          data-day="${d}" data-equipment="${equipId}">
                        ${text}
                    </div>`;
          }
          rows += "</div>";
        }

        document.getElementById('equipment-calendar').innerHTML = headerRow + rows;

        // Add double-click event listeners to equipment headers for editing (super admin only)
        const user = window.pharmaApp && window.pharmaApp.currentUser;
        document.querySelectorAll('.calendar-equipment-name-cell').forEach(cell => {
          cell.ondblclick = function(e) {
            if(user && user.role==='superadmin') {
              let oldName = cell.textContent;
              let equipId = cell.getAttribute('data-equipment-id');
              // Inline edit box
              cell.classList.add('editing');
              cell.innerHTML = `<input type="text" id="edit-equip-name-box" value="${oldName}" style="width:90%;" />`;
              let input = cell.querySelector('input');
              input.focus();
              input.onblur = function() {
                let newName = input.value.trim();
                if(newName && newName !== oldName) {
                  let eqIdx = equipmentList.findIndex(e=>String(e.id)===String(equipId));
                  if(eqIdx>-1) {
                    equipmentList[eqIdx].name = newName;
                    localStorage.setItem('pharma_equipment', JSON.stringify(equipmentList));
                    window.renderEquipmentCalendar(curMonth, curYear);
                    if(window.pharmaApp && window.pharmaApp.renderEquipmentPanel) window.pharmaApp.renderEquipmentPanel();
                  }
                } else {
                  cell.textContent = oldName;
                }
                cell.classList.remove('editing');
              };
              input.onkeydown = function(evt){
                if(evt.key==='Enter') input.blur();
                if(evt.key==='Escape') {input.value=oldName;input.blur();}
              };
            }
          };
        });
      };

      // Month navigation handlers
      document.addEventListener('DOMContentLoaded', function() {
        let prevBtn = document.getElementById('prev-month');
        let nextBtn = document.getElementById('next-month');
        let calendarAddBtn = document.getElementById('calendar-add-equipment-btn');
        let calendarDiv = document.getElementById('equipment-calendar');
        window.equipCalendarMonth = undefined;
        window.equipCalendarYear = undefined;

        prevBtn && (prevBtn.onclick = function() {
          let m = window.equipCalendarMonth;
          let y = window.equipCalendarYear;
          if(m===undefined || y===undefined) {
            let dt = new Date();
            m = dt.getMonth();
            y = dt.getFullYear();
          }
          m--;
          if(m<0) {m=11; y--;}
          window.renderEquipmentCalendar(m, y);
        });
        nextBtn && (nextBtn.onclick = function() {
          let m = window.equipCalendarMonth;
          let y = window.equipCalendarYear;
          if(m===undefined || y===undefined) {
            let dt = new Date();
            m = dt.getMonth();
            y = dt.getFullYear();
          }
          m++;
          if(m>11) {m=0;y++;}
          window.renderEquipmentCalendar(m, y);
        });

        // Add Equipment Button next to calendar
        calendarAddBtn && (calendarAddBtn.onclick = function() {
          let form = document.getElementById('equipment-form');
          document.getElementById('equipment-modal-title').textContent = "Add Equipment";
          form.reset();
          document.getElementById('equipment-id').value = '';
          document.getElementById('equipment-modal').classList.remove('hidden');
        });

        // Initial calendar render
        setTimeout(()=>window.renderEquipmentCalendar(),250);
      });
    })();
  </script>
</body>
</html>
